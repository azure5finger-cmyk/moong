<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모임 만들기 - MOONG!</title>
</head>

<body>
    {% include 'moong/navigation.html' %}

    <!-- 메시지 표시 -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 폼 전체 에러 -->
    {% if form.non_field_errors %}
    <div class="form-errors">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <p>
            <label>제목</label><br>
            {{ form.title }}
            {% if form.title.errors %}
                <span style="color: red;">{{ form.title.errors }}</span>
            {% endif %}
            <br>
            <label>내용</label><br>
            {{ form.content }}
            {% if form.content.errors %}
                <span style="color: red;">{{ form.content.errors }}</span>
            {% endif %}
            <br>
            <label>모임 날짜</label><br>
            {{ form.moim_date }}
            {% if form.moim_date.errors %}
                <span style="color: red;">{{ form.moim_date.errors }}</span>
            {% endif %}
            <br>
            <!-- 장소 (3단계 선택) -->
            <label for="sido">시/도</label>
            <select id="sido">
                <option value="">시/도 선택</option>
            </select>

            <label for="sigungu">시/군/구</label>
            <select id="sigungu">
                <option value="">시/군/구 선택</option>
            </select>

            <label for="eupmyeondong">읍/면/동</label>
            <!-- ⭐ Django Form의 location 필드와 연결 -->
            <select id="eupmyeondong" name="location">
                <option value="">읍/면/동 선택</option>
            </select>
            {% if form.location.errors %}
                <span style="color: red;">{{ form.location.errors }}</span>
            {% endif %}
            <br>
            <label>시간</label><br>
            {{ form.moim_time }}
            {% if form.moim_time.errors %}
                <span style="color: red;">{{ form.moim_time.errors }}</span>
            {% endif %}
            <br>
        </p>

        <button type="submit">게시</button>
        <button type="submit" name="save_temp">임시저장</button>

        {% include 'moong/tag_add.html' %}

    </form>
    
<!-- ===================== -->
<!-- AJAX 행정구역 JS -->
<!-- ===================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const sidoSelect = document.getElementById("sido");
  const sigunguSelect = document.getElementById("sigungu");
  const eupSelect = document.getElementById("eupmyeondong");

  // 1️⃣ 시/도 로드
  fetch("/locations/sido/")
    .then(res => res.json())
    .then(data => {
                    data.forEach(sido => {
        const opt = document.createElement("option");
        opt.value = sido;
        opt.textContent = sido;
        sidoSelect.appendChild(opt);
                    });
                })
    .catch(err => {
      console.error("시/도 로드 실패", err);
    });
        
  // 2️⃣ 시/도 변경 → 시/군/구
  sidoSelect.addEventListener("change", function () {
            const sido = this.value;
            
    // 하위 초기화
    sigunguSelect.innerHTML = `<option value="">시/군/구 선택</option>`;
    eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;
            
    if (!sido) return;

                fetch(`/locations/sigungu/?sido=${encodeURIComponent(sido)}`)
      .then(res => res.json())
                    .then(data => {
                        data.forEach(sigungu => {
          const opt = document.createElement("option");
          opt.value = sigungu;
          opt.textContent = sigungu;
          sigunguSelect.appendChild(opt);
                        });
                    })
      .catch(err => {
        console.error("시/군/구 로드 실패", err);
      });
        });
        
  // 3️⃣ 시/군/구 변경 → 읍/면/동
  sigunguSelect.addEventListener("change", function () {
            const sigungu = this.value;
    const sido = sidoSelect.value;
            
    eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;
            
    if (!sido || !sigungu) return;

    fetch(
      `/locations/eupmyeondong/?sido=${encodeURIComponent(sido)}&sigungu=${encodeURIComponent(sigungu)}`
    )
      .then(res => res.json())
                    .then(data => {
        console.log("받은 데이터:", data);

        data.forEach(obj => {
            console.log("추가하는 option:", obj.id, obj.name);
            const opt = document.createElement("option");
            opt.value = obj.id;       // ⭐ Location.id
            opt.textContent = obj.name;
            eupSelect.appendChild(opt);
                        });
                    })
      .catch(err => {
        console.error("읍/면/동 로드 실패", err);
      });
  });

        });
</script>

</body>
</html>