{% extends 'base.html' %}
{% load static %}

{% block myHead %}
<script src="{% static 'js/img_view.js' %}"></script>
{% endblock %}

{% block myBlock %}
    {% include 'moong/navigation.html' %}

    <div class="post-container">
        <div class="post-detail-card">
            <!-- 상태 배너 -->
            {% if post.is_closed %}
                <div class="status-banner confirmed">
                    <h2>모집이 확정되었습니다</h2>
                    <p>확정 인원: <strong>{{ post.get_approved_count }}명</strong>{% if post.max_people %} / {{ post.max_people }}명{% endif %}</p>
                    <p style="font-size: 14px; opacity: 0.9; margin-top: 8px;">{{ post.moim_date }} {{ post.moim_time }}에 진행 예정</p>
                </div>
            {% elif post.moim_finished %}
                <div class="status-banner finished">
                    <h2>완료된 모임</h2>
                    <p>이 모임은 성공적으로 완료되었습니다</p>
                </div>
            {% elif post.is_cancelled %}
                <div class="status-banner cancelled">
                    <h2>이 모임은 취소되었습니다</h2>
                    <p>주최자에 의해 취소된 모임입니다</p>
                </div>
            {% else %}
                <div class="status-banner recruiting">
                    <h2>모집 중입니다</h2>
                    <p>현재 인원: <strong>{{ post.get_approved_count }}명</strong>{% if post.max_people %} / {{ post.max_people }}명{% endif %}</p>
                </div>
            {% endif %}

            <!-- 게시글 헤더 -->
            <div class="post-detail-header">
                <h1 class="post-detail-title">{{ post.title }}</h1>
                <div class="post-detail-author">
                    {% if user == post.author %}
                        <a href="{% url 'users:mypage' %}">
                            <img src="{{ post.author.profile_image.url }}" alt="프로필">
                        </a>
                    {% else %}
                        <a href="{% url 'users:user_profile' post.author.id %}">
                            <img src="{{ post.author.profile_image.url }}" alt="프로필">
                        </a>
                    {% endif %}
                    <div class="post-detail-author-info">
                        {% if user == post.author %}
                            <a href="{% url 'users:mypage' %}" class="post-detail-author-name">{{ post.author.nick_name }}</a>
                        {% else %}
                            <a href="{% url 'users:user_profile' post.author.id %}" class="post-detail-author-name">{{ post.author.nick_name }}</a>
                        {% endif %}
                        <div class="post-detail-date">{{ post.create_time }}</div>
                    </div>
                </div>
            </div>

            <!-- 모임 정보 -->
            <div class="post-detail-info">
                <div class="post-info-item">
                    <strong>모임 날짜</strong>
                    <span>{{ post.moim_date }} {{ post.moim_time }}</span>
                </div>
                <div class="post-info-item">
                    <strong>모임 장소</strong>
                    <span>
                        {% if post.location %}
                            {{ post.location.sido }} {{ post.location.sigungu }} {{ post.location.eupmyeondong }}
                        {% else %}
                            장소 미정
                        {% endif %}
                    </span>
                </div>
                {% if post.max_people %}
                <div class="post-info-item">
                    <strong>최대 인원</strong>
                    <span>{{ post.max_people }}명</span>
                </div>
                {% endif %}
            </div>

            <!-- 본문 -->
            <div class="post-detail-content">
                <p>{{ post.content }}</p>

                {% if post.images.all %}
                <div class="post-detail-images">
                    {% for image in post.images.all %}
                        <img src="{{ image.image.url }}" alt="{{ post.title }}">
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- 참여 현황 -->
            <div class="participation-box">
                <div class="info-box">
                    참여 현황: <strong>{{ post.get_approved_count }}</strong> / {{ post.max_people }}명
                    {% if post.is_full %}
                        <span class="full-badge">[마감]</span>
                    {% endif %}
                </div>

                {% if request.user.is_authenticated %}
                    {% if is_applied %}
                        <form action="{% url 'moong:post_cancel' post.id %}" method="post" style="text-align: center;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">참여 취소하기</button>
                        </form>
                    {% else %}
                        <form action="{% url 'moong:post_apply' post.id %}" method="post" style="text-align: center;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary" {% if post.is_full %}disabled{% endif %}>
                                {% if post.is_full %}정원 초과{% else %}참여 신청하기{% endif %}
                            </button>
                        </form>
                    {% endif %}
                {% endif %}

                <details>
                    <summary>참여자 목록 보기 (현재 {{ approved_participants.count }}명)</summary>
                    <ul>
                        {% for participant in approved_participants %}
                            <li>
                                {{ participant.user.nick_name|default:participant.user.username }}
                                {% if participant.user == post.author %}
                                    <span style="color: var(--moong-primary);">(주최자)</span>
                                {% endif %}
                                <small style="color: var(--moong-text-light);">- {{ participant.create_time|date:"Y-m-d H:i" }} 신청</small>
                            </li>
                        {% empty %}
                            <li style="color: var(--moong-text-light);">참여자가 없습니다.</li>
                        {% endfor %}
                    </ul>
                </details>
            </div>

            <!-- 태그 -->
            <div class="post-detail-tags a-post-tags">
                {% for tag in post.hashtags.all %}
                    <a href="{% url 'moong:tag_feeds' tag.name %}" class="tag-link">#{{ tag.name }}</a>
                {% endfor %}
            </div>

            <!-- 댓글 -->
            <div style="padding: 24px; border-top: 2px solid var(--moong-bg-light);">
                {% include "moong/comments.html" with is_a_post=False %}
            </div>

            <!-- 메시지 -->
            {% if messages %}
            <div class="messages" style="padding: 0 24px;">
                {% for message in messages %}
                <div class="message {{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- 하단 버튼 -->
            <div class="post-detail-buttons">
                <a href="{% url 'moong:main' %}" class="btn btn-secondary">목록으로</a>
                {% if user == post.author %}
                    <a href="{% url 'moong:post_mod' post.id %}" class="btn btn-primary">모임글 수정</a>
                    {% if not post.is_closed %}
                        <form method="POST" action="{% url 'moong:post_closed' post.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">모집 확정</button>
                        </form>
                    {% else %}
                        <form method="POST" action="{% url 'moong:post_closed_cancel' post.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-secondary">모집 확정 취소</button>
                        </form>
                        <form method="POST" action="{% url 'moong:moim_finished' post.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">모임 완료</button>
                        </form>
                    {% endif %}
                    <form method="POST" action="{% url 'moong:post_delete' post.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" onclick="return confirm('모집글을 삭제하시겠습니까?\r\n확정 참여자가 없는 경우에만 삭제가 가능합니다');">
                            모임 삭제
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
{% endblock %}